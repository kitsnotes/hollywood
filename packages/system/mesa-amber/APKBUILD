# Contributor: Originull Software <packages@originull.org>
# Maintainer: Originull Software <packages@originull.org>
pkgname=mesa-amber
pkgver=21.3.9
pkgrel=2
pkgdesc="Classic OpenGL (non-Gallium3D) drivers"
url="https://www.mesa3d.org/"
arch="all"
license="MIT SGI-B-2.0 BSL-1.0"
depends="libglvnd"
checkdepends=""
install=""
options="!check"
subpackages="$pkgname-dev"
source="https://mesa.freedesktop.org/archive/mesa-${pkgver}.tar.xz"
builddir="$srcdir/mesa-$pkgver/"
provides="opengl"
depends_dev="
        libdrm-dev
        libxext-dev
        libxdamage-dev
        libxcb-dev
        libxshmfence-dev
        "
makedepends="
        $depends_dev
        bison
        eudev-dev
        expat-dev
        findutils
        flex
        gettext
        elfutils-dev
        glslang-dev
        libtool
        libxfixes-dev
        libva-dev
        libvdpau-dev
        libx11-dev
        libxml2-dev
        libxrandr-dev
        libxvmc-dev
        libxxf86vm-dev
        llvm$_llvmver-dev
        meson
        py3-mako
        python3
        libglvnd-dev
        wayland-dev
        wayland-protocols
        xorgproto
        zlib-dev
        zstd-dev
        "

build() {
	abuild-meson \
	    -D b_lto=true \
	    -D b_ndebug=true \
	    -D amber=true \
	    -D platforms=auto \
	    -D dri-drivers=i915,i965,r100,r200,nouveau \
	    -D gallium-drivers=swrast \
	    -D vulkan-drivers=auto \
	    -D dri3=enabled \
	    -D egl=enabled \
	    -D gbm=enabled \
	    -D gles1=disabled \
	    -D gles2=enabled \
	    -D glvnd=auto \
	    -D glx=dri \
	    -D llvm=enabled \
	    -D lmsensors=disabled \
	    -D osmesa=true \
	    -D shared-glapi=enabled \
	    -D microsoft-clc=disabled \
		output
	meson compile ${JOBS:+-j ${JOBS}} -C output
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output
	ln -s /usr/lib/libGLX_amber.so.0 "${pkgdir}/usr/lib/libGLX_indirect.so.0"
}

sha512sums="
4cec6f4f50f444fcd327f7c40f8899c2f265e348e121455262b540b1f890a1468bbea59965af0876c548fa97aa0a05a1b23fa6ca7d308bd60328cfdeab757684  mesa-21.3.9.tar.xz
"
